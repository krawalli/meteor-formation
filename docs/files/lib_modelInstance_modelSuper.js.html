<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>lib/modelInstance/modelSuper.js</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="shortcut icon" type="image/png" href="../assets/favicon.png">
    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
            
                <h1><img src="../assets/css/logo.png" title=""></h1>
            
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: </em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
    <h2 class="off-left">APIs</h2>
    <div id="api-tabview" class="tabview">
        <ul class="tabs">
            <li><a href="#api-classes">Classes</a></li>
            <li><a href="#api-modules">Modules</a></li>
        </ul>

        <div id="api-tabview-filter">
            <input type="search" id="api-filter" placeholder="Type to filter APIs">
        </div>

        <div id="api-tabview-panel">
            <ul id="api-classes" class="apis classes">
            
                <li><a href="../classes/Field.html">Field</a></li>
            
                <li><a href="../classes/FieldInstance.html">FieldInstance</a></li>
            
                <li><a href="../classes/Model.html">Model</a></li>
            
                <li><a href="../classes/ModelInstance.html">ModelInstance</a></li>
            
                <li><a href="../classes/ModelSuper.html">ModelSuper</a></li>
            
                <li><a href="../classes/NewModelInstance.html">NewModelInstance</a></li>
            
            </ul>

            <ul id="api-modules" class="apis modules">
            
                <li><a href="../modules/Field.html">Field</a></li>
            
                <li><a href="../modules/FieldInstance.html">FieldInstance</a></li>
            
                <li><a href="../modules/Formation.html">Formation</a></li>
            
                <li><a href="../modules/Model.html">Model</a></li>
            
                <li><a href="../modules/ModelInstance.html">ModelInstance</a></li>
            
            </ul>
        </div>
    </div>
</div>

            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
        Show:
        <label for="api-show-inherited">
            <input type="checkbox" id="api-show-inherited" checked>
            Inherited
        </label>

        <label for="api-show-protected">
            <input type="checkbox" id="api-show-protected">
            Protected
        </label>

        <label for="api-show-private">
            <input type="checkbox" id="api-show-private">
            Private
        </label>
        <label for="api-show-deprecated">
            <input type="checkbox" id="api-show-deprecated">
            Deprecated
        </label>

    </div>


            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
                        <h1 class="file-heading">File: lib/modelInstance/modelSuper.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">
/**
* @module Formation
* @submodule ModelInstance
*/

ModelInstanceSuper = function( params ){


  /**
  * Model Super Class; not usually used by end dev
  * @class ModelSuper
  * @constructor
  * @param {Object} data      Data to create ModelInstance with
  */
  function ModelInstance( data ){
    this._errors = new ReactiveVar( [] );
    var schema = this._model;

    // iterate through fields and add data
    for ( var field in schema ){
      if ( schema[ field ] instanceof Array ){
        data[ field ] = data[ field ] || [];
        this[ field ] = [];

        for ( var i=0; i &lt; data[ field ].length; i++ ){
          if ( this.__name__ === &quot;NewModelInstance&quot; ){
            this[ field ].push( new schema[ field ][ 0 ].newInstance( data[ field ][ i ] ) );
          } else {
            this[ field ].push( new schema[ field ][ 0 ].instance( data[ field ][ i ] ) );
          }
        }

        if ( _.isEmpty( this[ field ] ) ){
          for ( var i=0; i &lt; schema[ field ][ 0 ].extra; i++ ){
            this[ field ].push( new schema[ field ][ 0 ].newInstance );
          }
        }
      } else {
        this[ field ] = new schema[ field ].instance( data[ field ] );
        this[ field ]._editMode.set( this.__name__ === &quot;NewModelInstance&quot; );
      }
    }

    // if new instance, make sure all fields are in edit mode
    if ( this.__name__ === &quot;NewModelInstance&quot; ) this.editMode();

  }


  if ( Meteor.isServer ) params.model.editable = function(){ return true };

  Object.defineProperties( ModelInstance.prototype, {
    __name__: { value: params.__name__ },

    /**
    * Model that instance was instantiated from
    * @property _model
    * @type Model
    */
    _model: { value: params.model },

    /**
    * Passed in summary of model
    * @method summary
    * @return String
    */
    summary: { value: params.model.summary },

    /**
    * Passed in beforeSave hook of model
    * @method beforeSave
    */
    beforeSave: { value: params.model.hooks.beforeSave },

    /**
    * Passed in afterSave hook of model
    * @method afterSave
    */
    afterSave: { value: params.model.hooks.afterSave },

    /**
    * Passed in beforeValidation hook of model
    * @method beforeValidation
    */
    beforeValidation: { value: params.model.hooks.beforeValidation },

    /**
    * Passed in afterValidation hook of model
    * @method afterValidation
    */
    afterValidation: { value: params.model.hooks.afterValidation },

    /**
    * Passed in modelValidator hook of model
    * @method modelValidator
    * @return Match.Where
    */
    modelValidator: { value: params.model.hooks.modelValidator },

    /**
    * Check to see if model is editable by user; client-side only
    * @method editable
    * @return Boolen
    */
    editable: { value: typeof params.model.editable === &#x27;boolean&#x27; ? function(){ return params.model.editable; } : params.model.editable },

    /**
    * If model is editable by user, toggle editMode
    * @method editMode
    * @param {Boolean} boo [optional]
    * @return Boolean
    */
    editMode:  { value: function( boo ){

        if ( this.editable() ){
          var fields = this.fields();
          typeof boo === &quot;boolean&quot; ? this._editMode.set( boo ) : this._editMode.set( ! this._editMode.get() );

          for ( var field in fields ){
            if ( this._model[ field ] instanceof Array &amp;&amp; fields[ field ] instanceof Array ){
              for( var i=0; i &lt; fields[ field ].length; i++ ){
                fields[ field ][ i ].editMode( this.inEditMode() );
              }
            } else {
              fields[ field ].editMode( this.inEditMode() );
            }
          }

        }

        return this.inEditMode();
      }
    },

    /**
    * Returns current state of editMode
    * @method inEditMode
    * @return Boolean
    */
    inEditMode:  { value: function(){
        return this._editMode.get();
      }
    },


    /**
    * Model-level errors (as opposed to field-level errors)
    * @method errors
    * @return Array
    */
    errors: { value: function(){
        return this._errors.get();
      }
    },


    /**
    * All errors, field and model-level
    * @method getAllErrors
    * @return Object
    */
    getAllErrors: { value: function(){
        var self = this;
        var errors;

        var fields = self.fields();
        errors = {};

        for ( var field in fields ){

          if ( self._model[ field ] instanceof Array &amp;&amp; self[ field ] instanceof Array ){
            errors[ field ] = [];

            for ( var i=0; i &lt; self[ field ].length; i++ ){
              if ( self[ field ][ i ].hasErrors() ){
                errors[ field ].push( self[ field ][ i ].getAllErrors() );
              }
            }

          } else {
            if ( ( fields[ field ].__name__ === &quot;ModelInstance&quot; || fields[ field ].__name__ === &quot;NewModelInstance&quot; ) &amp;&amp; fields[ field ].hasErrors() ){
              errors[ field ] = self[ field ].getAllErrors();
            } else if ( self[ field ].hasErrors() ){
              errors[ field ] = self[ field ].errors();
            }
          }
        }

        return errors;
      }
    },


    /**
    * If model has errors field or model-level, return true; else false
    * @method hasErrors
    * @return Boolean
    */
    hasErrors: { value: function(){
        var ob = this.fields();
        var hasErr = false;
        var self = this;

        if ( ! _.isEmpty( this.errors() ) ){
          return true;
        }

        _.each( ob, function( value, key ){
          var errors = self._errors.get() instanceof Array ? self._errors.get() : [];
          if ( errors.length &gt; 0 ) hasErr = true;

          if ( value instanceof Array ){
            _.each( value, function( v, k ){
              if ( v.hasErrors() ) hasErr = true;
            });

          } else {
            if ( value.hasErrors() ) hasErr = true;
          }
        });

        return hasErr;
      }
    },

    /**
    * Return object of fields only, limited to fields preset in model
    * @method fields
    * @return Object
    */
    fields: { value: function(){
        var fields = {}
        for ( var field in this ){
          if ( _.has( this._model, field ) ){
            fields[ field ] = this[ field ];
          }
        }
        return fields;
      }
    },

    /**
    * Return array of fields
    * @method fieldsArray
    * @return Array
    */
    fieldsArray: { value: function(){
        return _.values( this.fields() );
      }
    },


    /**
    * If instance is NewModelInstance, return true; else false
    * @method isNew
    * @return Boolean
    */
    isNew: { value: function(){
        return this.__name__ === &#x27;NewModelInstance&#x27;;
      }
    },


    /**
    * Save to database; returns number of docs changed (either 1 on success or 0 on fail)
    * @method save
    * @return Number
    */
    save: { value: function( params, callback ){
        if ( this.beforeSave ){
          this.beforeSave();
        }

        this.validate();
        var data = this.getValue();

        if ( this.__name__ === &quot;NewModelInstance&quot; ){
          delete data._id;
          var objectId = this._model.collection.insert( data );
        } else {
          var objectId = this._model.collection.update( { _id: this._id }, { $set: data } );
        }

        if ( this.afterSave ){
          this.afterSave();
        }

        if ( callback &amp;&amp; typeof( callback ) === &#x27;function&#x27; ){
          callback( data );
        }

        this.editMode( false );

        return objectId;
      }
    },

    /**
    * Return plain JavaScript object with values.  Blank, non-required values and their fields are not included
    * @method getValue
    * @return Object
    */
    getValue: { value: function(){
        var data;
        var self = this;
        data = {};
        var fields = self.fields();

        for ( var field in fields ){
          if ( self._model[ field ] instanceof Array &amp;&amp; self[ field ] instanceof Array ){
            if ( ! _.isEmpty( self[ field ] ) ){
              data[ field ] = [];

              for ( var i=0; i &lt; self[ field ].length; i++ ){
                if ( self[ field ][ i ].__name__ !== &quot;NewModelInstance&quot; ){
                  data[ field ].push( self[ field ][ i ].getValue() );

                } else if ( self[ field ][ i ]._model.required || self[ field ][ i ].getValue() !== undefined ){
                  data[ field ].push( self[ field ][ i ].getValue() );
                }
              }
            }

          } else {
            data[ field ] = fields[ field ].getValue();
          }
        }

        for ( var field in data ){
          if ( data[ field ] === undefined ){
            delete data[ field ];
          }
        }


        if (! this._model.required &amp;&amp;
            _.isEmpty( _.compact( _.values( data ) ) ) &amp;&amp;
            this.__name__ === &quot;NewModelInstance&quot; ){
          return;
        }

        return data;
      }
    },


    /**
    * Validate instance; returns undefined on success; throws errors on failure
    * @method validate
    * @param {function} callback
    */
    validate: { value: function( callback ){
        this._errors.set( [] );

        if ( this.beforeValidation ){
          this.beforeValidation();
        }

        var fields = this.fields();
        for ( var field in fields ){
          if ( this._model[ field ] instanceof Array &amp;&amp; this[ field ] instanceof Array ){
            for ( var i=0; i &lt; this[ field ].length; i++ ){
              this[ field ][ i ].validate();
            }
          } else {
            fields[ field ].validate();
            if ( this._model &amp;&amp; fields[ field ].field ){
              if ( fields[ field ].field.unique &amp;&amp; this._model.collection ){
                var find = {};
                find[ field ] = fields[ field ].value;
                find._id = { &#x27;$ne&#x27;: this._id };

                if ( this._model.collection.find( find ).count() !== 0 ){
                  var errs = fields[ field ]._errors.get();
                  errs.push( new Error( &quot;This &quot; + field + &quot; already exists.&quot; ) );
                  this._errors.set( errs );
                }
              }
            }
          }
        }

        if ( this.modelValidator ){
          try {
            check( this.getValue(), this.modelValidator() );
          } catch( e ){
            var errs = this._errors.get();
            errs.push( e );
            this._errors.set( errs );
          }
        }

        // Remove errors of unrequired fields
        if ( this.hasErrors() &amp;&amp; this.__name__ === &quot;NewModelInstance&quot; ){
          if ( ! this._model.required ){

            var fields = this.fields();
            for ( var field in fields ){
              if ( ! this[ field ].field.required ){
                switch( typeof( this[ field ].value ) ){
                  case &#x27;undefined&#x27;:
                    this[ field ]._errors = [];
                    break;
                  case &#x27;string&#x27;:
                  case &#x27;array&#x27;:
                    if ( this[ field ].value.length === 0 ){
                      this[ field ].value = this[ field ].field.defaultValue();
                      this[ field ]._errors = [];
                    }
                    break;
                }
              }
            }
            this._errors.set( [] );
          }
        };

        if ( this.hasErrors() ){
          console.log( this.getAllErrors() );
          throw new Error( &#x27;Please check the fields for errors.&#x27; );
        }

        if ( this.afterValidation ){
          this.afterValidation();
        }

        if ( typeof( callback ) === &quot;function&quot; ){
          callback();
        }

      }
    }

  });

  // add virtual fields to prototype
  for ( var field in params.model.virtualFields ){
    if ( typeof( params.model.virtualFields[ field ] ) === &#x27;function&#x27; ){
      Object.defineProperty( ModelInstance.prototype, field, { value: params.model.virtualFields[ field ] } );
    } else {
      throw new Error( &quot;All virtual fields must be functions.&quot; );
    }
  }

  return ModelInstance;

};

    </pre>
</div>

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
